function Diff = Distance(samp_params,ISO,t,it,r,tol,num)
%% Load data for city
filename = [ISO,'_Data.mat'];
tmp = load(filename);

%% Setup variables

HCV_params=load('HCV_params.mat');

[model,Diff,Diff_vec] = Distance3(Get_Parameters(samp_params,ISO,HCV_params.HCV_params(1,:),'Calibration'),tmp.Data);

% Diff=Diff;
% tol=tol;
% if min(Diff<=tol)
% res = getenv('WORK');
%     Filename2 = '/Ukraine_Fitting/';
%     Filename3 = append(res,Filename2);
% fname2 = ['ABC_outputs',num2str(num),'/Output',num2str(t),'_',num2str(it),'_',num2str(r),'.mat'];
% fname = append(Filename3,fname2);
% save(fname,'model','Diff','Diff_vec')
% end

function [model,Diff,Diff_vec] = Distance3(params,Data)%#codegen
timestep = 0.1;
mydate=2022;
TIME= sort(unique([params.seed_date:timestep:mydate,Data.Time_pts]));
SS = Get_Initial_Conditions(params,'Calibration');
%options1 = odeset('NonNegative',1:(1*2*2*4*3*3*8*3*1),'AbsTol',1e-6,'RelTol',1e-6);
[t,y] = ode23(@(t,y)Ukraine_model(t,y,params,'Calibration',0),TIME,SS);
sum(sum(y<0));
add_outs = y(:,1*2*2*4*3*4*8*3*1+1:end); %
y_out = reshape(y(:,1:1*2*2*4*3*4*8*3*1), [length(t),1,2,2,4,3,4,8,3,1]);


a=size(add_outs);
b=size(y(:,1:1*2*2*4*3*4*8*3*1));
c=size(y_out);

PWID_prop_current_OST_com_client = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],[2,3],:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_current_OST_com_non_client = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,[2,3],:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,:,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_current_ART_com_client = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,2:8,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_current_ART_com_non_client = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,2:8,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_current_ART_com_young = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_current_ART_com_old = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100;

PWID_HIV_prevalence_com_m = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100;
PWID_HIV_prevalence_com_f = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100;
PWID_HIV_prevalence_com_y = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,2:8,:,:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,1:8,:,:),3),5),6),7),8),9),10)*100;
PWID_HIV_prevalence_com_o = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,2:8,:,:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,1:8,:,:),3),5),6),7),8),9),10)*100;
PWID_HIV_prevalence_never_inc =  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,1:8,:,:),3),4),5),6),7),8),9),10)*100;
PWID_HIV_prevalence_ever_inc =  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,1:8,:,:),3),4),5),6),7),8),9),10)*100;

PWID_HCV_AB_prevalence_never_inc =  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,:,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,:,:,:),3),4),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_ever_inc =  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,:,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_y = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,:,[2,3],:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,:,:,:),3),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_o = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,:,[2,3],:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,:,:,:),3),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_m = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_f = sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_HIV_neg = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,:,:),3),4),5),6),7),8),9),10)*100;
PWID_HCV_AB_prevalence_com_HIV_pos = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100;

PWID_prop_NGO_young = sum(y_out(:,1,:,1,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,:,1,[1,3,4],:,:,:,:,:),2:10)*100;
PWID_prop_NGO_old = sum(y_out(:,1,:,2,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,:,2,[1,3,4],:,:,:,:,:),2:10)*100;
PWID_prop_NGO_HIV_pos = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100;
PWID_prop_NGO_HIV_neg = sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,1,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,:,:),3),4),5),6),7),8),9),10)*100;


abc=sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,:,:,:,:,:,:),3),4),5),6),7),8),9),10);

model = struct('TIME',TIME,...
    'PWID_pop_size',sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,:,:,:,:,:,:),3),4),5),6),7),8),9),10),...
    'prop_female',sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_young', sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_male_com_young',sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_female_com_young',sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_ever_inc',sum(y_out(:,1,:,:,[3,4],:,:,:,:,:),3:10)./...
    sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3:10)*100,...
    'PWID_prop_recent_inc',sum(y_out(:,1,:,:,[3],:,:,:,:,:),3:10)./...
    sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3:10)*100,...
    'prop_rec_inc_young_male' , sum(sum(sum(sum(sum(y_out(:,1,1,1,3,:,:,:,:,:),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,:,:,:),5),6),7),8),9),10)*100,...
    'prop_rec_inc_old_male' , sum(sum(sum(sum(sum(y_out(:,1,1,2,3,:,:,:,:,:),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(y_out(:,1,1,2,[1,3,4],:,:,:,:,:),5),6),7),8),9),10)*100,...
    'prop_rec_inc_young_female' , sum(sum(sum(sum(sum(y_out(:,1,2,1,3,:,:,:,:,:),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,:,:,:),5),6),7),8),9),10)*100,...
    'prop_rec_inc_old_female' , sum(sum(sum(sum(sum(y_out(:,1,2,2,3,:,:,:,:,:),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(y_out(:,1,2,2,[1,3,4],:,:,:,:,:),5),6),7),8),9),10)*100,...
    'prop_rec_inc_NGO' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,3,[2,3],:,:,:,:),3),4),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'prop_rec_inc_non_NGO',sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,3,1,:,:,:,:),3),4),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_NGO_HIV_pos' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_NGO_HIV_neg' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,1,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_short_NGO_old' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,:,2,:,:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,:,[2,3],:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_m' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_f' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_y' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,2:8,:,:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,1:8,:,:),3),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_o' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,2:8,:,:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,1:8,:,:),3),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_ym' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_om' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,2,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,2,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_yf' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_com_of' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,2,[1,3,4],:,:,2:8,:,:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,2,[1,3,4],:,:,1:8,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_never_inc' ,  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,1:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HIV_prevalence_ever_inc' ,  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,1:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,:,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_y' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,:,[2,3],:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,1,[1,3,4],:,:,:,:,:),3),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_o' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,:,[2,3],:),3),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,2,[1,3,4],:,:,:,:,:),3),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_m' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,:,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_f' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,:,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_ym' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,1,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_om' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,2,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,1,2,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_yf' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,1,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_of' , sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,2,[1,3,4],:,:,:,[2,3],:),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(y_out(:,1,2,2,[1,3,4],:,:,:,:,:),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_never_inc' ,  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,:,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,1,:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_ever_inc' ,  sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,:,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_HIV_neg' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,1,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_HCV_AB_prevalence_com_HIV_pos' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,[2,3],:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_OST_com' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,[2,3],:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_OST_com_client' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],[2,3],:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_OST_com_non_client' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,[2,3],:,:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,:,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_ART_com' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_ART_com_client' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],[2,3],:,2:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'PWID_prop_current_ART_com_non_client' , sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,[4,6,8],:,:),3),4),5),6),7),8),9),10)./...
    sum(sum(sum(sum(sum(sum(sum(sum(y_out(:,1,:,:,[1,3,4],1,:,2:8,:,:),3),4),5),6),7),8),9),10)*100,...
    'OR_OST_NGO' , make_OR(PWID_prop_current_OST_com_client,PWID_prop_current_OST_com_non_client),...
    'OR_ART_NGO' , make_OR(PWID_prop_current_ART_com_client,PWID_prop_current_ART_com_non_client),...
    'OR_ART_old', make_OR(PWID_prop_current_ART_com_old,PWID_prop_current_ART_com_young),...
    'OR_NGO_young' , make_OR(PWID_prop_NGO_young,PWID_prop_NGO_old),...
    'OR_NGO_HIV' , make_OR(PWID_prop_NGO_HIV_pos,PWID_prop_NGO_HIV_neg),...
    'OR_HIV_young' , make_OR(PWID_HIV_prevalence_com_y,PWID_HIV_prevalence_com_o),...
    'OR_HIV_female' , make_OR(PWID_HIV_prevalence_com_f,PWID_HIV_prevalence_com_m),...
    'RR_HIV_prev_female', make_RR(PWID_HIV_prevalence_com_f, PWID_HIV_prevalence_com_m),...
    'OR_HCV_young' , make_OR(PWID_HCV_AB_prevalence_com_y,PWID_HCV_AB_prevalence_com_o),...
    'OR_HCV_female' , make_OR(PWID_HCV_AB_prevalence_com_f,PWID_HCV_AB_prevalence_com_m),...
    'RR_HCV_prev_female', make_RR(PWID_HCV_AB_prevalence_com_f, PWID_HCV_AB_prevalence_com_m),...
    'OR_HCV_HIV' , make_OR(PWID_HCV_AB_prevalence_com_HIV_pos,PWID_HCV_AB_prevalence_com_HIV_neg),...
    'RR_HIV_Incidence_rec_inc', [0; diff(add_outs(:,2))]./[timestep; diff(TIME')],... % using diff(TIME) rather than timestep because data may not conform to 0.1 year timesteps
    'RR_HIV_Incidence_nonrec_inc', [0; diff(add_outs(:,3))]./[timestep; diff(TIME')],...
    'RR_HCV_Incidence_rec_inc', [0; diff(add_outs(:,4))]./[timestep; diff(TIME')],...
    'RR_HCV_Incidence_nonrec_inc', [0; diff(add_outs(:,5))]./[timestep; diff(TIME')],...
    'RR_HIV_Incidence_homeless', [0; diff(add_outs(:,6))]./[timestep; diff(TIME')],...
    'RR_HCV_Incidence_homeless', [0; diff(add_outs(:,7))]./[timestep; diff(TIME')],...
    'PWID_prop_HIV_sexual', [0; diff(add_outs(:,1))]./[timestep; diff(TIME')],... %%%%%%%% ADDED BY ANTOINE
    'PWID_prop_homeless',sum(y_out(:,1,:,:,[1,3,4],2,:,:,:,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],[1,2],:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_young_male',sum(y_out(:,1,1,1,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,1,1,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_old_male',sum(y_out(:,1,1,2,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,1,2,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_young_female' , sum(y_out(:,1,2,1,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,2,1,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_old_female' , sum(y_out(:,1,2,2,[1,3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,2,2,[1,3,4],:,:,:,:,:),2:10)*100, ...
     'PWID_prop_NGO_ever_inc' , sum(y_out(:,1,:,:,[3,4],[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,:,:,[3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_never_inc', sum(y_out(:,1,:,:,1,[2,3],:,:,:,:),2:10)./...
        sum(y_out(:,1,:,:,1,:,:,:,:,:),2:10)*100,...
    'PWID_prop_NGO_HCV_pos', sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,2:3,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],:,:,:,2:3,:),2:10)*100,...
    'PWID_prop_NGO_HCV_neg', sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,1,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],:,:,:,1,:),2:10)*100,...
    'PWID_HIV_prevalence_com_HCV_neg', sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,1,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],:,:,1:8,1,:),2:10)*100,...
    'PWID_HIV_prevalence_com_HCV_pos', sum(y_out(:,1,:,:,[1,3,4],:,:,2:8,[2,3],:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],:,:,1:8,[2,3],:),2:10)*100,...
    'PWID_HIV_prevalence_com_non_client', sum(y_out(:,1,:,:,[1,3,4],1,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],1,:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_com_client', sum(y_out(:,1,:,:,[1,3,4],[2,3],:,2:8,:,:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],[2,3],:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_pris', sum(y_out(:,1,:,:,2,:,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,:,:,2,:,:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_pris_ym', sum(y_out(:,1,1,1,2,:,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,1,1,2,:,:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_pris_om', sum(y_out(:,1,1,2,2,:,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,1,2,2,:,:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_pris_yf', sum(y_out(:,1,2,1,2,:,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,2,1,2,:,:,1:8,:,:),2:10)*100,...
    'PWID_HIV_prevalence_pris_of', sum(y_out(:,1,2,2,2,:,:,2:8,:,:),2:10)./...
        sum(y_out(:,1,2,2,2,:,:,1:8,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_com_non_client', sum(y_out(:,1,:,:,[1,3,4],1,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],1,:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_com_client', sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,:,:,[1,3,4],[2,3],:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_pris', sum(y_out(:,1,:,:,2,:,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,:,:,2,:,:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_pris_ym', sum(y_out(:,1,1,1,2,:,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,1,1,2,:,:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_pris_om', sum(y_out(:,1,1,2,2,:,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,1,2,2,:,:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_pris_yf', sum(y_out(:,1,2,1,2,:,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,2,1,2,:,:,:,:,:),2:10)*100,...
    'PWID_HCV_AB_prevalence_pris_of', sum(y_out(:,1,2,2,2,:,:,:,[2,3],:),2:10)./...
        sum(y_out(:,1,2,2,2,:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_ym', sum(y_out(:,1,1,1,[1,3,4],:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,1,1,[1,3,4],:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_om', sum(y_out(:,1,1,2,[1,3,4],:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,1,2,[1,3,4],:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_yf', sum(y_out(:,1,2,1,[1,3,4],:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,2,1,[1,3,4],:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_of', sum(y_out(:,1,2,2,[1,3,4],:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,2,2,[1,3,4],:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_never_inc', sum(y_out(:,1,:,:,1,:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,:,:,1,:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_ever_inc', sum(y_out(:,1,:,:,[3,4],:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,:,:,[3,4],:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_recent_inc', sum(y_out(:,1,:,:,3,:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,:,:,3,:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_com_non_recent_inc', sum(y_out(:,1,:,:,4,:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,:,:,4,:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_ART_pris', sum(y_out(:,1,:,:,2,:,:,[4,6,8],:,:),2:10)./...
        sum(y_out(:,1,:,:,2,:,:,2:8,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_ym', sum(y_out(:,1,1,1,[1,3,4],:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,1,1,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_om', sum(y_out(:,1,1,2,[1,3,4],:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,1,2,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_yf', sum(y_out(:,1,2,1,[1,3,4],:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,2,1,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_of', sum(y_out(:,1,2,2,[1,3,4],:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,2,2,[1,3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_never_inc', sum(y_out(:,1,:,:,1,:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,:,:,1,:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_ever_inc', sum(y_out(:,1,:,:,[3,4],:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,:,:,[3,4],:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_recent_inc', sum(y_out(:,1,:,:,3,:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,:,:,3,:,:,:,:,:),2:10)*100,...
    'PWID_prop_current_OST_com_non_recent_inc', sum(y_out(:,1,:,:,4,:,[2,3],:,:,:),2:10)./...
        sum(y_out(:,1,:,:,4,:,:,:,:,:),2:10)*100); %%%% NEW FROM ANTOINE %timestep); %[timestep; diff(TIME')]); % using diff(TIME) rather than timestep because data may not conform to 0.1 year timesteps

%%

%Pop size
field = 'PWID_pop_size';
Diff_pop_size = Difference(field);

% Prop young
% Diff_young = nan(2,1);
% field = 'PWID_prop_female_com_young';
% Diff_young(1) = Difference_sqrd(field);
% field = 'PWID_prop_male_com_young';
% Diff_young(2) = Difference_sqrd(field);
% ind = (t==2015);
% Prop_young  = sum(sum(sum(sum(sum(sum(sum(sum(y_out(ind,1,:,1,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)./...
%     sum(sum(sum(sum(sum(sum(sum(sum(y_out(ind,1,:,:,[1,3,4],:,:,:,:,:),3),4),5),6),7),8),9),10)*100;
% Diff_young = abs(log(Prop_young)-log(10));
%     if Prop_young<20
%         Diff_young=0;
%     end
field = 'PWID_prop_young';
Diff_prop_young = Difference_sqrd(field);

% Ever incarcerated
Diff_ever_inc=nan(1,1);
field = 'PWID_prop_ever_inc';
%Diff_ever_inc(1) = Difference_prop(field);
Diff_ever_inc(1) = Difference_sqrd(field);

% RECENT incarcerated
Diff_recent_inc=nan(1,1);
field = 'PWID_prop_recent_inc';
Diff_recent_inc(1) = Difference_sqrd(field);

% HIV
%
Diff_HIV_OR = nan(4,1);
field = 'PWID_HIV_prevalence_com';
Diff_HIV_OR(1) = Difference_sqrd_multi(field);

field = 'RR_HIV_Incidence_rec_inc';
Diff_HIV_OR(2) = Difference_sqrd(field);

field = 'RR_HIV_Incidence_nonrec_inc';
Diff_HIV_OR(3) = Difference_sqrd(field);

field = 'RR_HIV_prev_female';
Diff_HIV_OR(4) = Difference_sqrd(field);


% HCV
Diff_HCV_OR = nan(5,1);
field = 'PWID_HCV_AB_prevalence_com';
Diff_HCV_OR(1) = Difference_sqrd(field);

field = 'RR_HCV_Incidence_rec_inc';
Diff_HCV_OR(2) = Difference_sqrd(field);

field = 'RR_HCV_Incidence_nonrec_inc';
Diff_HCV_OR(3) = Difference_sqrd(field);

field = 'RR_HCV_prev_female';
Diff_HCV_OR(4) = Difference_sqrd(field);

field = 'PWID_HCV_AB_prevalence_com_HIV_pos';
Diff_HCV_OR(5) = Difference_sqrd(field);

% Homeless
Diff_homeless = nan(3,1); %%%%%%%%%%%%% INDICES ARE DIFFERNT IN THE HIV ONLY MODEL (nan(2,1)
field = 'PWID_prop_homeless';
Diff_homeless(1) = Difference_sqrd(field);

field = 'RR_HIV_Incidence_homeless'; % RR of HIV acquisition if homeless
Diff_homeless(2) = Difference_sqrd(field);

field = 'RR_HCV_Incidence_homeless'; % RR of HCV acquisition if homeless
Diff_homeless(3) = Difference_sqrd(field);

% OAT status
Diff_OST = nan(1,1);
field = 'PWID_prop_current_OST_com';
Diff_OST(1) = Difference_sqrd(field);

% ART status
Diff_ART = nan(1,1);
field = 'PWID_prop_current_ART_com';
Diff_ART(1) = Difference_sqrd(field);

% prop HIV sexual %%%%%%%%%%%%%%%%%%%% WE ARE NOT CALIBRATING TO PROP SEX - DIFFERENT FROM THE HIV ONLY MODEL %%%%%%%%%%%%%%
% Diff_HIV_sexual = nan(1,1);
% field = 'PWID_prop_HIV_sexual';
% Diff_HIV_sexual(1) = Difference_sqrd(field);


Diff_vec=struct('Diff_prop_young',Diff_prop_young,...
    'Diff_recent_inc',Diff_recent_inc,...
    'Diff_ever_inc',Diff_ever_inc,...
    'Diff_HIV_OR',Diff_HIV_OR,...
    'Diff_HCV_OR',Diff_HCV_OR,...
    'Diff_homeless',Diff_homeless,...
    'Diff_OST',Diff_OST,...
    'Diff_ART',Diff_ART);%%%%%%%%%%%%%%%%%%% WE ARE NOT CALIBRATING TO PROP SEX - DIFFERENT FROM THE HIV ONLY MODEL %%%%%%%%%%%%%%



% Diff(1) = [sum(Diff_pop_size) + sum(Diff_prop_young) + sum(Diff_ever_inc)+ sum(Diff_recent_inc) + sum(Diff_homeless) +  ...
%    sum(Diff_HIV_OR) + sum(Diff_HCV_OR) ];%%%%%%%%%%%%%%%%% WE ARE NOT CALIBRATING TO PROP SEX - DIFFERENT FROM THE HIV ONLY MODEL %%%%%%%%%%%%%%

% Diff(2) = [sum(Diff_OST) + sum(Diff_ART)];

Diff(1) = [sum(Diff_pop_size) + sum(Diff_prop_young) +   ...
   sum(Diff_HIV_OR) + sum(Diff_HCV_OR) ];%%%%%%%%%%%%%%%%% WE ARE NOT CALIBRATING TO PROP SEX - DIFFERENT FROM THE HIV ONLY MODEL %%%%%%%%%%%%%%

Diff(2) = [sum(Diff_OST) + sum(Diff_ART)];




%Diff = sum(Diff);

Diff=[Diff(1),Diff(2)];

    function x = Difference(field)
        time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        l = Data.(char(field)).lower;
        u = Data.(char(field)).upper;
        %x = sum(abs(log(m(time_ind,:)) - log(est)));
        %x = sum(abs(m(time_ind,:) - est)./est);
        %
        x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*abs(log(m(time_ind,:)) - log(est)));
        %x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*(abs(m(time_ind,:) - est)./est));
    end
% 
%     function x = Difference2(field)
%         time_ind = ismember(TIME,Data.(char(field)).time_pt);
%         m = model.(char(field));
%         est = Data.(char(field)).estimate;
%         l = Data.(char(field)).lower;
%         u = Data.(char(field)).upper;
%         %x = sum(abs(log(m(time_ind,:)) - log(est)));
%         x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*abs(log(m(time_ind,:)) - log(est)));
%         %x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*(abs(m(time_ind,:) - est)./est));
%     end
    function x = Difference_sqrd(field)
      time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        l = Data.(char(field)).lower;
        u = Data.(char(field)).upper;
        %x = sum(abs(log(m(time_ind,:)) - log(est)));
        %x = sum(abs(m(time_ind,:) - est)./est);
        %
        x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*abs(log(m(time_ind,:)) - log(est)));
        
    end
    function x = Difference_log2(field)
      time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        l = Data.(char(field)).lower;
        u = Data.(char(field)).upper;
        %x = sum(abs(log(m(time_ind,:)) - log(est)));
        %x = sum(abs(m(time_ind,:) - est)./est);
        %
        x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*abs(log2(m(time_ind,:)) - log2(est)));
        
    end


    function x = Difference_sqrd10(field)
      time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        l = Data.(char(field)).lower;
        u = Data.(char(field)).upper;
        %x = sum(abs(log(m(time_ind,:)) - log(est)));
        %x = sum(abs(m(time_ind,:) - est)./est);
        %
        x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*10*abs(log(m(time_ind,:)) - log(est)));
        
    end




    function x = Difference_sqrd_multi(field)
        date_data = Data.(char(field)).time_pt;
        date_data_unique = unique(date_data);               % list of unique dates
        time_ind = [];                                      % to be filled: list of time vector indeces corresponding to dates, including duplicates
        for k=1:length(date_data_unique)
            datek = date_data_unique(k);                    % one of the unique dates
            nk = sum(date_data == datek);                   % duplicity of datek
            time_indk = find(TIME == datek);                % time vector index corresponding to datek
            time_ind = [time_ind repmat(time_indk,[1,nk])]; % fill time_ind with the current index, including duplicates
        end
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        l = Data.(char(field)).lower;
        u = Data.(char(field)).upper;
        x = sum((1-(m(time_ind,:)>=l).*(m(time_ind,:)<=u)).*abs(log(m(time_ind,:)) - log(est)));
    end

    function x = Difference_prop(field)
        time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field))/100;
        est = Data.(char(field)).estimate;
        N = Data.(char(field)).N;
        n = est/100.*N;
        x1 = -log(betapdf(m(time_ind,:),n,N-n));
        tmp = abs(m(time_ind,:)*100-est);
        x= sum(min(x1,-tmp*log(1e-323)));
    end

    function x = Difference_OR(field)
        time_ind = ismember(TIME,Data.(char(field)).time_pt);
        m = model.(char(field));
        est = Data.(char(field)).estimate;
        upper = Data.(char(field)).upper;
        lower = Data.(char(field)).lower;
        se = (log(upper)-log(lower))./(2*1.96);
        x = -sum(log(normpdf(log(m(time_ind,:)),log(est),se)));
        %tmp = abs(m(time_ind,:)-est);
        %x= sum(min(x1,-tmp.*log(1e-323)));
    end

    function OR = make_OR(prev1,prev2)
        odds1 = prev1/100./(1-prev1/100);
        odds2 = prev2/100./(1-prev2/100);
        OR = odds1./odds2;
    end

    function RR = make_RR(prev1,prev2)
        RR = prev1./prev2;
    end
end


end
